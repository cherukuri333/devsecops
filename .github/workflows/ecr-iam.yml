name: Setup AWS ECR and IAM Role

on:
  push:
    branches: [ main ]
    paths:
      - "ecr-iam-creation/**"

jobs:
  create-ecr-and-role:
    runs-on: self-hosted

    env:
      AWS_REGION: us-east-1
      ECR_REPOSITORY: my-Ecr-dev
      IAM_ROLE_NAME: github-ecr-role-dev

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Create ECR Repository
        run: |
          aws ecr describe-repositories --repository-names $ECR_REPOSITORY || \
          aws ecr create-repository --repository-name $ECR_REPOSITORY
          echo "ECR repository $ECR_REPOSITORY ready."

      - name: Create IAM Role for GitHub Actions
        run: |
          # Trust policy allowing GitHub OIDC or any service that you plan to use
          TRUST_POLICY='{
            "Version": "2012-10-17",
            "Statement": [
              {
                "Effect": "Allow",
                "Principal": {
                  "AWS": "arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:root"
                },
                "Action": "sts:AssumeRole"
              }
            ]
          }'

          # Create the role if it doesn't exist
          if ! aws iam get-role --role-name $IAM_ROLE_NAME; then
            aws iam create-role --role-name $IAM_ROLE_NAME --assume-role-policy-document "$TRUST_POLICY"
            echo "IAM Role $IAM_ROLE_NAME created."
          else
            echo "IAM Role $IAM_ROLE_NAME already exists."
          fi

      - name: Attach Policy to IAM Role
        run: |
          POLICY_ARN=$(aws iam list-policies --query "Policies[?PolicyName=='ECRPushPolicy'].Arn" --output text)
          if [ -z "$POLICY_ARN" ]; then
            aws iam create-policy --policy-name ECRPushPolicy --policy-document '{
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "ecr:GetAuthorizationToken",
                    "ecr:BatchCheckLayerAvailability",
                    "ecr:PutImage",
                    "ecr:InitiateLayerUpload",
                    "ecr:UploadLayerPart",
                    "ecr:CompleteLayerUpload",
                    "ecr:DescribeRepositories",
                    "ecr:CreateRepository"
                  ],
                  "Resource": "*"
                }
              ]
            }'
            POLICY_ARN=$(aws iam list-policies --query "Policies[?PolicyName=='ECRPushPolicy'].Arn" --output text)
          fi

          aws iam attach-role-policy --role-name $IAM_ROLE_NAME --policy-arn $POLICY_ARN
          echo "Policy attached to $IAM_ROLE_NAME."
