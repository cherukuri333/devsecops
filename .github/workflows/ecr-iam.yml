name: Setup AWS ECR and IAM Role

on:
  push:
    branches: [ main ]
    paths:
      - "ecr-iam-creation/**"

jobs:
  create-ecr-and-role:
    runs-on: self-hosted

    env:
      AWS_REGION: us-east-1
      ECR_REPOSITORY: my-ecr-dev
      IAM_ROLE_NAME: github-ecr-role-dev
      POLICY_NAME: github-ecr-push-policy-dev

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # - name: Verify AWS identity
      #   run: aws sts get-caller-identity

      - name: Create ECR Repository (idempotent)
        run: |
          aws ecr describe-repositories \
            --repository-names "$ECR_REPOSITORY" \
          || aws ecr create-repository \
            --repository-name "$ECR_REPOSITORY" \
            --region "$AWS_REGION"

      - name: Create IAM Role (idempotent)
        run: |
          TRUST_POLICY=$(cat <<EOF
          {
            "Version": "2012-10-17",
            "Statement": [
              {
                "Effect": "Allow",
                "Principal": {
                  "AWS": "arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:root"
                },
                "Action": "sts:AssumeRole"
              }
            ]
          }
          EOF
          )

          aws iam get-role --role-name "$IAM_ROLE_NAME" >/dev/null 2>&1 || \
          aws iam create-role \
            --role-name "$IAM_ROLE_NAME" \
            --assume-role-policy-document "$TRUST_POLICY"

      - name: Create IAM Policy (idempotent)
        run: |
          POLICY_ARN=$(aws iam list-policies \
            --scope Local \
            --query "Policies[?PolicyName=='$POLICY_NAME'].Arn" \
            --output text)

          if [ -z "$POLICY_ARN" ]; then
            POLICY_ARN=$(aws iam create-policy \
              --policy-name "$POLICY_NAME" \
              --policy-document '{
                "Version": "2012-10-17",
                "Statement": [
                  {
                    "Effect": "Allow",
                    "Action": [
                      "ecr:GetAuthorizationToken",
                      "ecr:BatchCheckLayerAvailability",
                      "ecr:InitiateLayerUpload",
                      "ecr:UploadLayerPart",
                      "ecr:CompleteLayerUpload",
                      "ecr:PutImage",
                      "ecr:DescribeRepositories"
                    ],
                    "Resource": "*"
                  }
                ]
              }' \
              --query "Policy.Arn" \
              --output text)
          fi

          aws iam attach-role-policy \
            --role-name "$IAM_ROLE_NAME" \
            --policy-arn "$POLICY_ARN"
